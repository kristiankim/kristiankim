---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { projects as fallbackProjects } from '../../data/content';
import { getProjects, urlFor } from '../../lib/sanity';

const sanityProjects = await getProjects();
const projects = sanityProjects.length
  ? sanityProjects.map((p) => ({
      ...p,
      slug: p.slug.current,
      coverImageUrl: p.cover?.asset ? urlFor(p.cover)?.width(1800).quality(85).url() : null,
      teamMembers: p.teamMembers ?? [],
      impact: p.impact ?? [],
      isPrivate: Boolean(p.isPrivate),
    }))
  : fallbackProjects.map((p) => ({ ...p, coverImageUrl: null }));

export async function getStaticPaths() {
  const { getProjects } = await import('../../lib/sanity');
  const { projects: fallbackProjects } = await import('../../data/content');
  const sanityProjects = await getProjects();
  const items = sanityProjects.length
    ? sanityProjects.map((p) => ({ slug: p.slug.current }))
    : fallbackProjects.map((p) => ({ slug: p.slug }));

  return items.map((project) => ({ params: { slug: project.slug } }));
}

const { slug } = Astro.params;
const project = projects.find((p) => p.slug === slug);
if (!project) return Astro.redirect('/works');
---
<BaseLayout title={project.title}>
  <article class="case">
    {project.coverImageUrl && (
      <img class="cover" src={project.coverImageUrl} alt={project.title} loading="lazy" />
    )}

    <h1>{project.title}</h1>
    {project.isPrivate && <p class="private">Private case study</p>}

    <h2>Meta data</h2>
    <ul>
      <li>Year: {project.year}</li>
      <li>Company: {project.company}</li>
      <li>Website: {project.website || 'N/A'}</li>
      <li>Team members: {(project.teamMembers || []).join(', ')}</li>
      <li>Role: {project.role}</li>
    </ul>

    <h2>Overview</h2>
    <p>{project.overview}</p>

    <h2>Case study</h2>
    <p>Text + images sections are enabled in schema plan and will be connected to Sanity Portable Text blocks.</p>

    <h2>Outcome / impact metrics</h2>
    <ul>
      {(project.impact || []).map((item) => <li>{item}</li>)}
    </ul>
  </article>
</BaseLayout>

<style>
  .case { max-width: 100%; }
  .cover {
    width: 100%;
    aspect-ratio: 16 / 7;
    object-fit: cover;
    border-radius: .35rem;
    margin-bottom: 1rem;
  }
  h1 { margin: 0 0 0.8rem; font-size: clamp(1.8rem, 3.2vw, 2.6rem); letter-spacing: -0.02em; }
  h2 { margin: 2rem 0 .8rem; font-size: 1.05rem; letter-spacing: -0.01em; }
  p, li { color: var(--muted); }
  ul { margin: 0; padding-left: 1.1rem; }
  .private { display: inline-block; color: var(--muted); border: 1px solid var(--line); padding: .2rem .5rem; border-radius: 999px; font-size: .82rem; }
</style>
