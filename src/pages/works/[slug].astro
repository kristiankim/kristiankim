---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { projects as fallbackProjects } from '../../data/content';
import { getProjects } from '../../lib/sanity';

const sanityProjects = await getProjects();
const projects = sanityProjects.length
  ? sanityProjects.map((p) => ({
      ...p,
      slug: p.slug.current,
      teamMembers: p.teamMembers ?? [],
      impact: p.impact ?? [],
      isPrivate: Boolean(p.isPrivate),
    }))
  : fallbackProjects;

export async function getStaticPaths() {
  const { getProjects } = await import('../../lib/sanity');
  const { projects: fallbackProjects } = await import('../../data/content');
  const sanityProjects = await getProjects();
  const items = sanityProjects.length
    ? sanityProjects.map((p) => ({ slug: p.slug.current }))
    : fallbackProjects.map((p) => ({ slug: p.slug }));

  return items.map((project) => ({ params: { slug: project.slug } }));
}

const { slug } = Astro.params;
const project = projects.find((p) => p.slug === slug);
if (!project) return Astro.redirect('/works');
---
<BaseLayout title={project.title}>
  <article>
    <h1>{project.title}</h1>
    {project.isPrivate && <p class="private">Private case study</p>}
    <h2>Meta data</h2>
    <ul>
      <li>Year: {project.year}</li>
      <li>Company: {project.company}</li>
      <li>Website: {project.website || 'N/A'}</li>
      <li>Team members: {(project.teamMembers || []).join(', ')}</li>
      <li>Role: {project.role}</li>
    </ul>
    <h2>Overview</h2>
    <p>{project.overview}</p>
    <h2>Case study</h2>
    <p>Text + images sections are enabled in schema plan and will be connected to Sanity Portable Text blocks.</p>
    <h2>Outcome / impact metrics</h2>
    <ul>
      {(project.impact || []).map((item) => <li>{item}</li>)}
    </ul>
  </article>
</BaseLayout>

<style>
article{max-width:820px}.private{color:var(--muted)}h1{font-size:clamp(2rem,4vw,3rem)}h2{margin-top:2rem}
</style>
