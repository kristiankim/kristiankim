---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { thoughts as fallbackThoughts } from '../../data/content';
import { getPosts } from '../../lib/sanity';

const sanityPosts = await getPosts();
const thoughts = sanityPosts.length
  ? sanityPosts.map((p) => ({
      slug: p.slug.current,
      title: p.title,
      category: p.category || 'Thoughts',
      publishedAt: (p.publishedAt || '').slice(0, 10),
      sections: p.body?.length ? ['This post is stored in Sanity. Portable Text rendering will be connected in the next step.'] : [],
    }))
  : fallbackThoughts;

export async function getStaticPaths() {
  const { getPosts } = await import('../../lib/sanity');
  const { thoughts: fallbackThoughts } = await import('../../data/content');
  const sanityPosts = await getPosts();
  const items = sanityPosts.length
    ? sanityPosts.map((p) => ({ slug: p.slug.current }))
    : fallbackThoughts.map((p) => ({ slug: p.slug }));

  return items.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = thoughts.find((p) => p.slug === slug);
if (!post) return Astro.redirect('/thoughts');
---
<BaseLayout title={post.title}>
  <article>
    <h1>{post.title}</h1>
    <p class="meta">{post.publishedAt} Â· {post.category}</p>
    <nav class="toc">
      <h2>Table of contents</h2>
      <ol>
        {post.sections.map((_, idx) => <li><a href={`#point-${idx + 1}`}>Point {idx + 1}</a></li>)}
      </ol>
    </nav>
    {post.sections.map((section, idx) => (
      <section id={`point-${idx + 1}`}>
        <h3>Point {idx + 1}</h3>
        <p>{section}</p>
      </section>
    ))}
  </article>
</BaseLayout>

<style>
article{max-width:760px}.meta{color:var(--muted)}.toc{border:1px solid var(--line);padding:1rem;border-radius:.5rem;margin:1.25rem 0 2rem}ol{margin:0;padding-left:1.2rem}section{margin:1.5rem 0}
</style>
