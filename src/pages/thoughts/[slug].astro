---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { thoughts as fallbackThoughts } from '../../data/content';
import { getPosts } from '../../lib/sanity';

const sanityPosts = await getPosts();
const thoughts = sanityPosts.length
  ? sanityPosts.map((p) => ({
      slug: p.slug.current,
      title: p.title,
      category: p.category || 'Thoughts',
      publishedAt: (p.publishedAt || '').slice(0, 10),
      tags: ['Reflection', 'Personal'],
      sections: p.body?.length
        ? ['This post is stored in Sanity. Portable Text rendering will be connected in the next step.']
        : [],
    }))
  : fallbackThoughts.map((p) => ({ ...p, tags: ['Reflection', 'Personal'] }));

export async function getStaticPaths() {
  const { getPosts } = await import('../../lib/sanity');
  const { thoughts: fallbackThoughts } = await import('../../data/content');
  const sanityPosts = await getPosts();
  const items = sanityPosts.length
    ? sanityPosts.map((p) => ({ slug: p.slug.current }))
    : fallbackThoughts.map((p) => ({ slug: p.slug }));

  return items.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = thoughts.find((p) => p.slug === slug);
if (!post) return Astro.redirect('/thoughts');

const readableDate = post.publishedAt
  ? new Date(`${post.publishedAt}T00:00:00`).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    })
  : '';
---

<BaseLayout title={post.title}>
  <article class="article">
    <section class="hero">
      <div class="hero-copy">
        <h1>{post.title}</h1>
      </div>
      <div class="hero-media" role="img" aria-label="Article cover image"></div>
    </section>

    <section class="meta-row">
      <span>↳ {post.category}</span>
      <span>{readableDate}</span>
      <span>{post.tags.join(' · ')}</span>
    </section>

    <section class="content-grid">
      <aside class="toc">
        <a href="#point-1">Understanding My Procrastination</a>
        <a href="#point-2">Strategies for Overcoming Procrastination</a>
        <a href="#point-3">Conclusion</a>
      </aside>

      <div class="body">
        {post.sections.map((section, idx) => (
          <section id={`point-${idx + 1}`}>
            <h2>
              {idx === 0
                ? 'Understanding My Procrastination'
                : idx === 1
                ? 'Strategies for Overcoming Procrastination'
                : 'Conclusion'}
            </h2>
            <p>{section}</p>
          </section>
        ))}
      </div>
    </section>
  </article>
</BaseLayout>

<style>
  .article {
    max-width: 1040px;
  }

  .hero {
    display: grid;
    grid-template-columns: 1fr 1.15fr;
    gap: 2rem;
    align-items: end;
    margin-top: 1.1rem;
  }

  .hero-copy h1 {
    margin: 0;
    font-size: clamp(2rem, 4.2vw, 3.4rem);
    line-height: 1.02;
    letter-spacing: -0.03em;
    font-family: Inter, 'Avenir Next', 'Helvetica Neue', sans-serif;
    font-weight: 500;
    max-width: 15ch;
  }

  .hero-media {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 0.25rem;
    background:
      linear-gradient(140deg, rgba(25, 25, 25, 0.25), rgba(25, 25, 25, 0.25)),
      url('https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?auto=format&fit=crop&w=1400&q=80') center/cover no-repeat;
  }

  .meta-row {
    margin-top: 1.8rem;
    border-bottom: 1px solid var(--line);
    padding-bottom: 0.9rem;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    color: var(--muted);
    font-size: 0.82rem;
  }

  .content-grid {
    margin-top: 1.6rem;
    display: grid;
    grid-template-columns: 220px minmax(0, 1fr);
    gap: 2.4rem;
  }

  .toc {
    display: grid;
    gap: 0.65rem;
    align-content: start;
    position: sticky;
    top: 1.2rem;
    font-size: 0.86rem;
  }

  .toc a {
    color: var(--muted);
    text-decoration: none;
  }

  .toc a:hover {
    color: var(--text);
  }

  .body {
    max-width: 680px;
  }

  .body section {
    margin-bottom: 2rem;
  }

  .body h2 {
    margin: 0 0 0.7rem;
    font-size: 2rem;
    font-family: Inter, 'Avenir Next', 'Helvetica Neue', sans-serif;
    letter-spacing: -0.02em;
    font-weight: 550;
  }

  .body p {
    margin: 0;
    color: var(--muted);
    line-height: 1.75;
    font-size: 1rem;
  }

  @media (max-width: 920px) {
    .hero {
      grid-template-columns: 1fr;
    }

    .hero-copy h1 {
      max-width: none;
    }

    .content-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .toc {
      position: static;
      padding-bottom: 0.8rem;
      border-bottom: 1px solid var(--line);
    }

    .meta-row {
      grid-template-columns: 1fr;
      gap: 0.3rem;
    }
  }
</style>
