---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { thoughts as fallbackThoughts } from '../../data/content';
import { getPosts, urlFor } from '../../lib/sanity';

type PortableChild = { _type?: string; text?: string };
type PortableBlock = {
  _type?: string;
  _key?: string;
  style?: string;
  children?: PortableChild[];
  asset?: unknown;
  alt?: string;
};

const toText = (block: PortableBlock) =>
  (block.children || [])
    .filter((child) => child?._type === 'span')
    .map((child) => child.text || '')
    .join('')
    .trim();

const slugify = (value: string) =>
  value
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-');

const sanityPosts = await getPosts();
const thoughts = sanityPosts.length
  ? sanityPosts.map((p) => ({
      slug: p.slug.current,
      title: p.title,
      category: p.category || 'Thoughts',
      publishedAt: (p.publishedAt || '').slice(0, 10),
      tags: p.tags?.length ? p.tags : ['Reflection', 'Personal'],
      coverImageUrl: p.coverImage?.asset ? urlFor(p.coverImage)?.width(1400).quality(85).url() : null,
      coverImageAlt: p.coverImage?.alt || p.title,
      bodyBlocks: (p.body || []) as PortableBlock[],
    }))
  : fallbackThoughts.map((p) => ({
      ...p,
      tags: ['Reflection', 'Personal'],
      coverImageUrl:
        'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?auto=format&fit=crop&w=1400&q=80',
      coverImageAlt: p.title,
      bodyBlocks: (p.sections || []).map((section, idx) => ({
        _type: 'block',
        style: idx === 0 ? 'h2' : 'normal',
        children: [{ _type: 'span', text: section }],
      })),
    }));

export async function getStaticPaths() {
  const { getPosts } = await import('../../lib/sanity');
  const { thoughts: fallbackThoughts } = await import('../../data/content');
  const sanityPosts = await getPosts();
  const items = sanityPosts.length
    ? sanityPosts.map((p) => ({ slug: p.slug.current }))
    : fallbackThoughts.map((p) => ({ slug: p.slug }));

  return items.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = thoughts.find((p) => p.slug === slug);
if (!post) return Astro.redirect('/thoughts');

const readableDate = post.publishedAt
  ? new Date(`${post.publishedAt}T00:00:00`).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    })
  : '';

const headings = post.bodyBlocks
  .filter((block) => block._type === 'block' && (block.style === 'h2' || block.style === 'h3'))
  .map((block) => {
    const text = toText(block);
    return {
      id: block._key || slugify(text),
      text,
      level: block.style || 'h2',
    };
  })
  .filter((heading) => heading.text);
---

<BaseLayout title={post.title}>
  <article class="article">
    <section class="hero">
      <div class="hero-copy">
        <h1>{post.title}</h1>
      </div>
      {post.coverImageUrl ? (
        <img class="hero-media" src={post.coverImageUrl} alt={post.coverImageAlt} loading="lazy" />
      ) : (
        <div class="hero-media placeholder" aria-hidden="true"></div>
      )}
    </section>

    <section class="meta-row">
      <span>↳ {post.category}</span>
      <span>{readableDate}</span>
      <span>{post.tags.join(' · ')}</span>
    </section>

    <section class="content-grid">
      <aside class="toc">
        {headings.length ? (
          headings.map((heading) => (
            <a class={heading.level === 'h3' ? 'sub' : ''} href={`#${heading.id}`}>
              {heading.text}
            </a>
          ))
        ) : (
          <span>No headings yet</span>
        )}
      </aside>

      <div class="body">
        {post.bodyBlocks.map((block, idx) => {
          if (block._type === 'block') {
            const text = toText(block);
            if (!text) return null;

            if (block.style === 'h2' || block.style === 'h3') {
              const id = block._key || slugify(text);
              return block.style === 'h3' ? <h3 id={id}>{text}</h3> : <h2 id={id}>{text}</h2>;
            }

            return <p>{text}</p>;
          }

          if (block._type === 'image' && block.asset) {
            const imageUrl = urlFor(block)?.width(1400).quality(85).url();
            return imageUrl ? <img class="content-image" src={imageUrl} alt={block.alt || `Image ${idx + 1}`} loading="lazy" /> : null;
          }

          return null;
        })}
      </div>
    </section>
  </article>
</BaseLayout>

<style>
  .article { max-width: 1040px; }
  .hero { display: grid; grid-template-columns: 1fr 1.15fr; gap: 2rem; align-items: end; margin-top: 1.1rem; }
  .hero-copy h1 { margin: 0; font-size: clamp(2rem, 4.2vw, 3.4rem); line-height: 1.02; letter-spacing: -0.03em; font-family: Inter, 'Avenir Next', 'Helvetica Neue', sans-serif; font-weight: 500; max-width: 15ch; }
  .hero-media { width: 100%; aspect-ratio: 16 / 9; border-radius: 0.25rem; object-fit: cover; }
  .hero-media.placeholder { background: var(--chip); }
  .meta-row { margin-top: 1.8rem; border-bottom: 1px solid var(--line); padding-bottom: 0.9rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; color: var(--muted); font-size: 0.82rem; }
  .content-grid { margin-top: 1.6rem; display: grid; grid-template-columns: 220px minmax(0, 1fr); gap: 2.4rem; }
  .toc { display: grid; gap: 0.65rem; align-content: start; position: sticky; top: 1.2rem; font-size: 0.86rem; }
  .toc a { color: var(--muted); text-decoration: none; }
  .toc a.sub { padding-left: 0.85rem; }
  .toc a:hover { color: var(--text); }
  .body { max-width: 680px; display: grid; gap: 1rem; }
  .body h2, .body h3 { margin: 1rem 0 0.2rem; font-size: 2rem; font-family: Inter, 'Avenir Next', 'Helvetica Neue', sans-serif; letter-spacing: -0.02em; font-weight: 550; }
  .body h3 { font-size: 1.35rem; }
  .body p { margin: 0; color: var(--muted); line-height: 1.75; font-size: 1rem; }
  .content-image { width: 100%; border-radius: 0.35rem; margin: 0.6rem 0; }
  @media (max-width: 920px) {
    .hero { grid-template-columns: 1fr; }
    .hero-copy h1 { max-width: none; }
    .content-grid { grid-template-columns: 1fr; gap: 1rem; }
    .toc { position: static; padding-bottom: 0.8rem; border-bottom: 1px solid var(--line); }
    .meta-row { grid-template-columns: 1fr; gap: 0.3rem; }
  }
</style>
